#include "user_dao.h"
#include <errno.h>
#include <sys/stat.h>
#include <pthread.h>
#include <string.h>



///////////////////////////////////////////////////////////////////////////////////////////////////
// constants
///////////////////////////////////////////////////////////////////////////////////////////////////
// paths
#define STORAGE_DIR_PATH "storage/"



///////////////////////////////////////////////////////////////////////////////////////////////////
// global variables
///////////////////////////////////////////////////////////////////////////////////////////////////
pthread_mutex_t mutex_storage;



///////////////////////////////////////////////////////////////////////////////////////////////////
// init
///////////////////////////////////////////////////////////////////////////////////////////////////

int init_user_dao()
{
    // create the storage directory if it doesn't exist
    if (mkdir(STORAGE_DIR_PATH, S_IRWXU) != 0 && errno != EEXIST)   // error occured, but not 
    {                                                               // because the the folder 
        return INIT_USER_DAO_ERR_FOLDER_CREATION;                   // already existed
    }

    // initialize mutex
    if (pthread_mutex_init(&mutex_storage, NULL) != 0)
    {
        return INIT_USER_DAO_ERR_MUTEX_INIT;
    }

    return INIT_USER_DAO_SUCCESS;
}



///////////////////////////////////////////////////////////////////////////////////////////////////
// destroy
///////////////////////////////////////////////////////////////////////////////////////////////////

int destroy_user_dao()
{
    if (pthread_mutex_destroy(&mutex_storage) != 0)
    {
        return DESTROY_USER_DAO_ERR_MUTEX;
    }

    return DESTROY_USER_DAO_SUCCESS;
}



///////////////////////////////////////////////////////////////////////////////////////////////////
// create_user
///////////////////////////////////////////////////////////////////////////////////////////////////

int create_user(char* name)
{
    // create user directory path
    char dir_path[strlen(STORAGE_DIR_PATH) + strlen(name) + 1];
    strcpy(dir_path, STORAGE_DIR_PATH);
    strcat(dir_path, name);

    // create user directory
    if (mkdir(dir_path, S_IRWXU) != 0)
    {          
        if (errno == EEXIST)     
            return CREATE_USER_ERR_EXISTS;    
        else
            return CREATE_USER_ERR_DIRECTORY;             
    }

    return CREATE_USER_SUCCESS;
}